<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MyPage - ìº˜ë¦°ë” ë° í•  ì¼ ê´€ë¦¬</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">MyPage</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <button class="btn btn-outline-danger" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-5">
    <h2 class="text-center">ğŸ“… ë‚´ ìº˜ë¦°ë”</h2>

    <!-- ìº˜ë¦°ë” ëª©ë¡ -->
    <table class="table table-bordered mt-4">
        <thead class="table-light">
        <tr>
            <th>#</th>
            <th>ìº˜ë¦°ë” ì œëª©</th>
            <th>ê¸°ê°„</th>
            <th>ì¥ì†Œ</th>
            <th>ê´€ë¦¬</th>
        </tr>
        </thead>
        <tbody id="calendar-list">
        <!-- ìº˜ë¦°ë” ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
        </tbody>
    </table>

    <!-- ìº˜ë¦°ë” ì¶”ê°€ ë²„íŠ¼ -->
    <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#calendarModal"
            onclick="openCalendarModal()">+ ìº˜ë¦°ë” ì¶”ê°€
    </button>

    <!-- ìº˜ë¦°ë” ê´€ë¦¬ ëª¨ë‹¬ -->
    <div class="modal fade" id="calendarModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">ğŸ“… ìº˜ë¦°ë” ê´€ë¦¬</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="calendar-id">
                    <div class="mb-3">
                        <label for="calendar-title" class="form-label">ìº˜ë¦°ë” ì œëª©</label>
                        <input type="text" class="form-control" id="calendar-title" placeholder="ìº˜ë¦°ë” ì œëª© ì…ë ¥">
                    </div>
                    <div class="mb-3">
                        <label for="calendar-description" class="form-label">ì„¤ëª…</label>
                        <input type="text" class="form-control" id="calendar-description" placeholder="ì„¤ëª… ì…ë ¥">
                    </div>
                    <div class="mb-3">
                        <label for="calendar-location" class="form-label">ìœ„ì¹˜</label>
                        <input type="text" class="form-control" id="calendar-location" placeholder="ìœ„ì¹˜ ì…ë ¥">
                    </div>
                    <div class="mb-3">
                        <label for="calendar-startDate" class="form-label">ì‹œì‘ ë‚ ì§œ</label>
                        <input type="date" class="form-control" id="calendar-startDate">
                    </div>
                    <div class="mb-3">
                        <label for="calendar-endDate" class="form-label">ì¢…ë£Œ ë‚ ì§œ</label>
                        <input type="date" class="form-control" id="calendar-endDate">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="saveCalendar()">ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

</div>
<div class="container mt-5">
    <h2 class="text-center mt-5">ğŸ“© ì´ˆëŒ€ë°›ì€ ì¼ì •</h2>
    <table class="table table-bordered mt-4">
        <thead class="table-light">
        <tr>
            <th>#</th>
            <th>ì¼ì • ì œëª©</th>
            <th>ê¸°ê°„</th>
            <th>ì¥ì†Œ</th>
            <th>ê´€ë¦¬</th>
        </tr>
        </thead>
        <tbody id="invited-calendar-list">
        <!-- ì´ˆëŒ€ë°›ì€ ì¼ì •ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
        </tbody>
    </table>


    <!-- ìº˜ë¦°ë” ê´€ë¦¬ ëª¨ë‹¬ -->
    <div class="modal fade" id="inviteModal" tabindex="-1" aria-labelledby="inviteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="inviteModalLabel">ğŸ“§ ì‚¬ìš©ì ì´ˆëŒ€</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="invite-calendar-id">
                    <div class="mb-3">
                        <label for="invite-email" class="form-label">ì´ˆëŒ€í•  ì´ë©”ì¼</label>
                        <input type="email" class="form-control" id="invite-email" placeholder="ì´ë©”ì¼ ì…ë ¥">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="sendInvite()">ì´ˆëŒ€ ë³´ë‚´ê¸°</button>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- âœ… JavaScript ì½”ë“œ ì¶”ê°€ -->
<script>
    let calendars = [];
    let todos = [];

    document.addEventListener("DOMContentLoaded", fetchCalendars);

    function apiFetch(url, method, body = null) {
        let token = localStorage.getItem("accessToken") || "";

        if (!token.startsWith("Bearer ")) {
            token = "Bearer " + token;
        }

        const headers = {
            "Content-Type": "application/json",
            "Authorization": token
        };

        console.log(`ğŸš€ API ìš”ì²­: ${method} ${url}`);
        console.log("ğŸ“Œ Headers:", headers);
        console.log("ğŸ“Œ Body:", body);

        return fetch(url, {
            method,
            headers,
            body: body ? JSON.stringify(body) : null
        })
            .then(response => {
                console.log("ğŸ“Œ ì‘ë‹µ ìƒíƒœ ì½”ë“œ:", response.status);
                console.log("ğŸ“Œ ì‘ë‹µ í—¤ë”:", response.headers.get("content-type"));

                const contentType = response.headers.get("content-type");

                // âœ… JSON ì‘ë‹µì¸ì§€ í™•ì¸ í›„ ì²˜ë¦¬
                if (contentType && contentType.includes("application/json")) {
                    return response.json();
                } else {
                    return response.text().then(text => {
                        console.warn("âš ï¸ ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ í˜•ì‹, ì›ë³¸ ì‘ë‹µ:", text);
                        throw new Error("ì„œë²„ ì‘ë‹µì´ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
                    });
                }
            })
            .catch(error => {
                console.error("âŒ API í˜¸ì¶œ ì‹¤íŒ¨:", error);
                throw error;
            });
    }

    function fetchCalendars() {
        apiFetch("/api/calendar/readcalendar", "GET")
            .then(data => {
                console.log("ğŸ“… ì „ì²´ ì¼ì • ë°ì´í„°:", data); // API ì‘ë‹µ í™•ì¸

                if (!data.result || data.result.length === 0) {
                    console.error("âŒ APIì—ì„œ ë°›ì€ ì¼ì • ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                // ì²« ë²ˆì§¸ ë°ì´í„° êµ¬ì¡° í™•ì¸
                console.log("ğŸ” ì²« ë²ˆì§¸ ì¼ì • ê°ì²´ êµ¬ì¡°:", data.result[0]);

                // âœ… inviteStatus ê¸°ë°˜ í•„í„°ë§
                calendars = data.result.filter(calendar => calendar.inviteStatus === "ACCEPTED");
                invitedCalendars = data.result.filter(calendar => calendar.inviteStatus === "PENDING");

                console.log("âœ… í•„í„°ë§ëœ ACCEPTED ì¼ì •:", calendars);
                console.log("âœ… í•„í„°ë§ëœ PENDING ì¼ì •:", invitedCalendars);

                renderCalendarList();
                renderInvitedCalendarList();
            })
            .catch(error => console.error("Error fetching calendars:", error));
    }


    function openCalendarModal(id = null) {
        console.log("ğŸ›  ìˆ˜ì • ë²„íŠ¼ í´ë¦­ë¨, ìº˜ë¦°ë” ID:", id);

        const modalElement = document.getElementById('calendarModal');
        if (!modalElement) {
            console.error("âŒ ëª¨ë‹¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
            return;
        }

        const modal = new bootstrap.Modal(modalElement);

        if (id) {
            if (!calendars || calendars.length === 0) {
                console.error("âŒ ìº˜ë¦°ë” ëª©ë¡ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤!");
                return;
            }

            const calendar = calendars.find(cal => String(cal.id) === String(id));
            if (!calendar) {
                console.error("âŒ í•´ë‹¹ ìº˜ë¦°ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤! ìº˜ë¦°ë” ëª©ë¡:", calendars);
                return;
            }

            console.log("ğŸ“Œ ë¶ˆëŸ¬ì˜¨ ìº˜ë¦°ë” ë°ì´í„°:", calendar);

            document.getElementById('calendar-id').value = calendar.id;
            document.getElementById('calendar-title').value = calendar.title;
            document.getElementById('calendar-description').value = calendar.description;
            document.getElementById('calendar-location').value = calendar.location;
            document.getElementById('calendar-startDate').value = calendar.startDate;
            document.getElementById('calendar-endDate').value = calendar.endDate;
        } else {
            console.log("ğŸ“Œ ìƒˆ ìº˜ë¦°ë” ì¶”ê°€ ëª¨ë“œ");
            document.getElementById('calendar-id').value = "";
            document.getElementById('calendar-title').value = "";
            document.getElementById('calendar-description').value = "";
            document.getElementById('calendar-location').value = "";
            document.getElementById('calendar-startDate').value = "";
            document.getElementById('calendar-endDate').value = "";
        }

        modal.show();
    }

    function saveCalendar() {
        const id = document.getElementById('calendar-id').value;
        const requestData = {
            title: document.getElementById('calendar-title').value,
            description: document.getElementById('calendar-description').value,
            location: document.getElementById('calendar-location').value,
            startDate: document.getElementById('calendar-startDate').value,
            endDate: document.getElementById('calendar-endDate').value
        };

        apiFetch(id ? `/api/calendar/updatecalendar/${id}` : "/api/calendar", id ? "PUT" : "POST", requestData)
            .then(() => fetchCalendars())
            .catch(error => console.error("Error saving calendar:", error));

        bootstrap.Modal.getInstance(document.getElementById('calendarModal')).hide();
    }

    function deleteCalendar(id) {
        console.log("ğŸ›  ì‚­ì œí•  ìº˜ë¦°ë” ID:", id);
        if (!id) {
            console.error("âŒ ìº˜ë¦°ë” IDê°€ ì—†ìŠµë‹ˆë‹¤!");
            return;
        }
        apiFetch(`/api/calendar/deletecalendar/${id}`, "DELETE")
            .then(() => {
                console.log("ğŸ—‘ ì‚­ì œ ì™„ë£Œ!");
                fetchCalendars();
            })
            .catch(error => console.error("âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error));
    }

    function renderCalendarList() {
        const tbody = document.getElementById('calendar-list');
        tbody.innerHTML = "";

        calendars.forEach((calendar, index) => {
            const row = document.createElement("tr");
            row.innerHTML = `
            <td>${index + 1}</td>
            <td><a href="#" onclick="fetchTodos('${calendar.id}')">${calendar.title}</a></td>
            <td>${calendar.startDate} ~ ${calendar.endDate}</td>
            <td>${calendar.location}</td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="openCalendarModal('${calendar.id}')">âœ ìˆ˜ì •</button>
                <button class="btn btn-danger btn-sm" onclick="deleteCalendar('${calendar.id}')">ğŸ—‘ ì‚­ì œ</button>
                <button class="btn btn-info btn-sm" onclick="inviteUser('${calendar.id}')">ğŸ“§ ì´ˆëŒ€</button>
            </td>
        `;
            tbody.appendChild(row);
        });
    }

    function fetchInvitedCalendars(calendarId) {
        console.log(`ğŸ“Œ fetchInvitedCalendars() í˜¸ì¶œë¨ - calendarId:`, calendarId);

        if (!calendarId || calendarId === "undefined") {
            console.error("âŒ ìœ íš¨í•˜ì§€ ì•Šì€ calendarId:", calendarId);
            return;
        }

        apiFetch(`/api/calendar/${calendarId}/invite/list`, "GET")
            .then(data => {
                console.log("ğŸ“Œ ì„œë²„ ì‘ë‹µ ë°ì´í„°:", data);

                if (!data.result) {
                    console.error("âŒ ì„œë²„ì—ì„œ ë°›ì€ ì´ˆëŒ€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                invitedCalendars = data.result;
                renderInvitedCalendarList();
            })
            .catch(error => console.error("âŒ ì´ˆëŒ€ë°›ì€ ì¼ì • ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error));
    }

    function inviteUser(calendarId) {
        const username = prompt("ì´ˆëŒ€í•  ì‚¬ìš©ìì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:");
        if (!username) return;

        console.log(`ğŸ“Œ ì´ˆëŒ€ ìš”ì²­ - calendarId: ${calendarId}, username: ${username}`);

        apiFetch(`/api/calendar/${calendarId}/invite?username=${username}`, "POST")
            .then(data => {
                console.log("ğŸ“Œ API ì‘ë‹µ ë°ì´í„°:", data);

                if (!data || typeof data !== "object") {
                    throw new Error("ì„œë²„ ì‘ë‹µì´ ì˜¬ë°”ë¥¸ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
                }

                if (data.statusCode === 400) {
                    throw new Error(data.message || "ì´ˆëŒ€í•  ìˆ˜ ì—†ëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤.");
                } else if (data.statusCode === 500) {
                    throw new Error("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ: ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
                }

                alert("âœ… ì´ˆëŒ€ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
            })
            .catch(error => {
                console.error("âŒ ì´ˆëŒ€ ì‹¤íŒ¨:", error);
                alert(`âŒ ì´ˆëŒ€ ì‹¤íŒ¨: ${error.message}`);
            });
    }

    function renderInvitedCalendarList() {
        console.log("ğŸ“© ì´ˆëŒ€ë°›ì€ ì¼ì • ë Œë”ë§ ì‹œì‘:", invitedCalendars);
        const tbody = document.getElementById('invited-calendar-list');
        tbody.innerHTML = "";

        invitedCalendars.forEach((calendar, index) => {
            if (calendar.inviteStatus !== "PENDING") return;

            const row = document.createElement("tr");
            row.innerHTML = `
            <td>${index + 1}</td>
            <td>${calendar.title}</td>
            <td>${calendar.startDate} ~ ${calendar.endDate}</td>
            <td>${calendar.location || "ë¯¸ì •"}</td>
            <td>
                <button class="btn btn-success btn-sm" onclick="respondToInvite('${calendar.inviteId}', 'ACCEPTED')">âœ” ìˆ˜ë½</button>
                <button class="btn btn-danger btn-sm" onclick="respondToInvite('${calendar.inviteId}', 'DECLINED')">âŒ ê±°ë¶€</button>
            </td>
        `;
            tbody.appendChild(row);
        });

        console.log("ğŸ“© ì´ˆëŒ€ë°›ì€ ì¼ì • ë Œë”ë§ ì™„ë£Œ");
    }

    function respondToInvite(inviteId, status) {
        console.log(`ğŸ“Œ ì´ˆëŒ€ ìƒíƒœ ë³€ê²½ ìš”ì²­: inviteId=${inviteId}, status=${status}`);

        if (!inviteId || inviteId === "undefined" || inviteId === "null") {
            console.error("âŒ ìœ íš¨í•˜ì§€ ì•Šì€ inviteId:", inviteId);
            alert("âŒ ì´ˆëŒ€ IDê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤!");
            return;
        }

        apiFetch(`/api/calendar/invite/${inviteId}?status=${status}`, "PUT")
            .then(response => {
                console.log("âœ… ì‘ë‹µ:", response);
                alert(`âœ… ìƒíƒœê°€ ${status}ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                fetchInvitedCalendars();
                fetchCalendars();
            })
            .catch(error => {
                console.error("âŒ ì´ˆëŒ€ ì‘ë‹µ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                alert("âŒ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨!");
            });
    }

    function logout() {
        localStorage.removeItem("accessToken");
        alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
        window.location.href = "/index.html";
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
